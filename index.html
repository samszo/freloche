<!doctype html>
<html lang="fr-FR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Freloche</title>
    <link rel="stylesheet" href="assets/css/main.css" />
    <link rel="stylesheet" href="assets/css/loader.css" />
    <link rel="stylesheet" href="assets/css/bootstrap5.3.min.css" />
    <link rel="stylesheet" href="assets/css/all.min.css" />
    <link rel="manifest" href="manifest.json" />
    <link rel="icon" href="assets/icons/papi.png" />

    <script src="assets/js/bootstrap5.3.bundle.min.js"></script>
    <script src="assets/js/all.min.js"></script>
    <script src="assets/js/d3.min.js"></script>
    <script src="assets/js/hex-lib.js"></script>
    <script src="assets/js/hex-algorithms.js"></script>

  </head>
  <body>
    <div id="ec" ></div>
    <script src="assets/app.js" defer></script>
    <!-- Register the app's service worker. -->
    <script>
    if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("assets/sw.js").then(
          (registration) => {
            console.log("Service worker registration successful:", registration);
          },
          (error) => {
            console.error(`Service worker registration failed: ${error}`);
          },
        );
      } else {
        console.error("Service workers are not supported.");
      }
    </script>

<script type="module">
    import carto from './assets/js/cartoHexa.js';
    import * as points from './assets/js/cartoPoints.js';
    import anime from './assets/js/anime.es.js';
    import {auth} from './assets/js/auth.js';

    /*récupère les data
    */
    let sources = {
      'omk':[
        {'id':2}
      ],
      //
      'octaviana': [
        {'idCol':346},{'idCol':347},{'idCol':348},{'idCol':349},{'idCol':350},{'idCol':351},
        {'idItem':6324}, {'idItem':6382}
      ]
      //
    },
    carte = new carto.cartoHexa({'idCont':'ec','eventClickHexa':selectHexa}),
    hexas = d3.selectAll(".gInit");
    moveHexa();
    carte.wait.show();
    let a = new auth({
                mail:'samuel.szoniecky@univ-paris8.fr',
                apiOmk:'../omk_creationsp8/api/',
                ident: 'dgs91Ps3nMp42INkjLWoudBlChTHcQ9h',
                key: 'zLBzJGoI76NLGxjX3aaX3fAjB4Ht6Gk9'
            });
    a.getUser(u=>getSources()); 


    function moveHexa(){
      let size = carte.getSize();
      //
      d3.select("#svgCartoHexach0")
      /*
        .append("svg")
          .style('position',"absolute")
          .style('top',"-"+size.height/2+"px")
          .style('left',"-"+size.width/4+"px")
          .attr('width',size.width)
          .attr('height',size.height)
        //.attr('viewbox',"0 0 3000 800")
      */
        .append("path")
          .attr('id','motionPath')
          .attr("fill","none").attr("stroke","currentColor").attr("stroke-width","1")
          //.attr("d","M8,56 C8,33.90861 25.90861,16 48,16 C70.09139,16 88,33.90861 88,56 C88,78.09139 105.90861,92 128,92 C150.09139,92 160,72 160,56 C160,40 148,24 128,24 C108,24 96,40 96,56 C96,72 105.90861,92 128,92 C154,93 168,78 168,56 C168,33.90861 185.90861,16 208,16 C230.09139,16 248,33.90861 248,56 C248,78.09139 230.09139,96 208,96 L48,96 C25.90861,96 8,78.09139 8,56 Z")
          .attr("d",`m 2.7245418,0.91363655
c 25.1200002,0 45.4500002,-20.32999955 45.4500002,-45.44999955 0,-25.120001 -20.33,-45.45 -45.4500002,-45.45 -50.2499998,0 -90.9099998,40.66 -90.9099998,90.90999955 0,50.24999845 40.66,90.90999845 90.9099998,90.90999845 75.3700002,0 136.3599982,-60.989998 136.3599982,-136.359998 0,-75.369997 -60.989998,-136.360007 -136.3599982,-136.360007 -100.4999998,0 -181.8200018,81.320007 -181.8200018,181.82000655 0,100.49999345 81.320002,181.81999345 181.8200018,181.81999345 125.6199982,0 227.2699982,-101.649995 227.2699982,-227.269993 0,-125.620007 -101.65,-227.300007 -227.2699982,-227.300007 -150.7500018,0 -272.7300018,121.98001 -272.7300018,272.73000655 0,150.74999345 121.98,272.72999345 272.7300018,272.72999345 175.8699982,0 318.1799982,-142.31 318.1799982,-318.179993 0,-175.870007 -142.31,-318.190007 -318.1799982,-318.190007 -200.9900018,0 -363.6399918,162.64 -363.6399918,363.64000655 0,200.99999345 162.63999,363.63999345 363.6399918,363.63999345 226.1199982,0 409.0899982,-182.97 409.0899982,-409.089993 0,-226.120007 -182.97,-409.100007 -409.0899982,-409.100007 -251.2400018,0 -454.5399918,203.3 -454.5399918,454.55000655 0,251.24999345 203.29999,454.54999345 454.5499918,454.54999345 276.3699982,0 499.9999982,-223.63 499.9999982,-499.999993 0,-276.370007 -223.63,-500.000007 -499.9999982,-500.000007`)
          ;
      //    
      var path = anime.path('#motionPath');
      anime({
        targets: '#svgCartoHexach0',
        translateX:path('x'),
        translateY: path('y'),
        //rotate: path('angle'),
        easing: 'linear',
        duration: 10000,
        loop: true
      });
      //
    }


    async function getSources(s=0,i=0){
      let ts = Object.keys(sources);
      await getSource(ts[s],i);
      //on ne précharge que omk
      if(s==0 & sources[ts[s]].length-1 > i) await getSources(s,i+1);
      else if(s==0 & ts.length-1 > s) await getSources(s+1,0);
      else updateTofs();
    }

    async function updateTofs(){
      //ajoute les photos dans chaque hexa
      Promise.all(d3.range(hexas.size()).map(i=>getAleaTof())).then(tofs => {
        hexas.selectAll('image').remove();
        hexas.append("image")
          .attr('href',(d,i)=>tofs[i])
          .attr('x',"-50")
          .attr('y',"-50")
          .attr('height',"100")
          .attr('width',"100");
          carte.wait.hide(true);
      });      
    }

    async function getSource(s,i){
      switch (s) {
        case 'omk':
          return sources[s][i] = await getOmk(sources[s][i]);
          break;      
        case 'octaviana':
          return sources[s][i] = await getOctaviana(sources[s][i]);
          break;      
      }
    }

    async function getOctaviana(octa){
        //récupère une source octaviana
        let url = octa.idCol ? "octaviana.php?idCol="+octa.idCol : "octaviana.php?idItem="+octa.idItem;
        octa.data= await d3.json(url);          
        if(octa.idItem)octa.files = await d3.json("octaviana.php?idFiles="+octa.data.id);
        //console.log(octa);
        return octa;
    }

    async function getOmk(item){
        item = a.omk.getItem(item.id);
        let m = await a.omk.getMedias(item);
        //console.log(item);
        return item;
    }

    async function getAleaTof(){
      let ts = Object.keys(sources), 
        s = ts[d3.randomInt(ts.length)()],
        i = sources[s][d3.randomInt(0,sources[s].length-1)()];
        console.log(s);
        switch (s) {
          case 'omk':
            return await getAleaTofOmk(i);
            break;      
          case 'octaviana':
            return await getAleaTofOctaviana(i);
            break;      
        }
    }

    async function getAleaTofOctaviana(octa){
        //choisi une source octaviana
        if(!octa.data){
          octa = await getOctaviana(octa);
        }
        if(octa.idCol){
            //choisi un item
            let itemCol = octa.data[d3.randomInt(0,octa.data.length-1)()],
                itemFind = sources.octaviana.filter(o=>o.idItem==itemCol.id);
            if(!itemFind.length){
                octa = await getOctaviana({'idItem':itemCol.id});
                sources.octaviana.push(octa);
            }else{
                octa = itemFind[0];
            }
        }
        console.log(octa);
        //choisi une photo
        return octa.files[d3.randomInt(0,octa.files.length-1)()].file_urls.square_thumbnail;
    }

    async function getAleaTofOmk(item){
        //choisi une source octaviana
        if(!item.medias){
          item = await getOmk(item);
        }
        console.log(item);
        //choisi une photo
        return item.medias[d3.randomInt(0,item.medias.length-1)()]["o:thumbnail_urls"].large;
    }

    function selectHexa(e,h){
        console.log(h);
        let hexa = d3.select(e.currentTarget);
        hexa.select('image').remove();
        getAleaTofOctaviana().then(urlTof => {
          console.log(urlTof);
          hexa.append("image")
            .attr('href',urlTof)
            .attr('x',"-50")
            .attr('y',"-50")
            .attr('height',"100")
            .attr('width',"100");
        });
    }

</script>

</body>
</html>
